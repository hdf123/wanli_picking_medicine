<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>登录</title>
		<link rel="stylesheet" href="css/mui.min.css">
		<link rel="stylesheet" href="css/mui.css" />
		<link rel="stylesheet" href="../../css/base.css" />
		<link rel="stylesheet" href="css/app.css" />
		<link rel="stylesheet" href="../../css/iconfont.css" />
		<link rel="stylesheet" href="css/login.css" />
		<script src="../../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/ajaxs.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/md5.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
	</head>
	<body>
		<div class="logs">
			<div>
				<img src="../../img/login_01.png" alt="" />
			</div>
		</div>
		<div class="loga">
			<div>
				<div class="iconfont icon-wode"></div>
				<!--13783493211    17303831924-->
				<input type="number" id="tel" placeholder="请输入手机号" value="15137102387"/>
			</div>
			<div>
				<div class="iconfont icon-mima"></div>
				<input type="password" id="pass" placeholder="请输入密码" value="ad123456"/>
			</div>
		</div>
		<div class="login">登录</div>
		<div class="logb">
			<div>注册</div>
			<div>忘记密码</div>
		</div>
		<div class="logc">
			<!--<div class="iconfont icon-QQ"></div>-->
			<div class="iconfont icon-weixin" id="weixin"></div>
			<!--<div class="iconfont icon-weibo"></div>-->
		</div>
<script src="js/mui.min.js"></script>
<script src="js/mui.zoom.js"></script>
<script src="js/mui.previewimage.js"></script>
<script src="js/tools.js" ></script>
<script type="text/javascript">
	$(function(){
		var one=0;
		var parameter={
			phone:3,
			password:3,
			kkk:3
		}
		localStorage.setItem('logs', JSON.stringify(parameter));
		localStorage.setItem('one', JSON.stringify(one));
		$(".login").on("click",function(){
			var pho = $('#tel').val();
			var pass=$("#pass").val();
			pho==""||pass==""?alert("填写不可为空"):funelse();//判断输入是否为空
			function funelse(){
				var df=/^(13[0-9]|14[579]|15[0-3,5-9]|16[6]|17[0135678]|18[0-9]|19[89])\d{8}$/;//手机号正则
				df.test(pho)?funcel():alert("账号格式错误！");
			}
			function funcel(){
				pass=hex_md5(pass);
				var parameter={
					userName:pho,
					password:pass,
					kkk:6
				}
				ajaxsd("user/mobilePhoneLogin",'post',parameter,function(data){
					console.log(data);
					if(data.success==true){
					    localStorage.setItem('logs', JSON.stringify(parameter));
						window.location.href="../home/home.html";
					}else{
						return alert(data.message);
					}
				},function(err){
					console.log(err);
					console.log(JSON.stringify(err));
				})
			}
		})
		$(".logb>div").click(function(){
			console.log($(this).index());
			var index=$(this).index();
			if(index==0){
				window.location.href="registered.html";
			}else{
				window.location.href="forget.html";
			}
		})
//第三方登录
		var tyindex=0;
		// 获取用户头像标签
		mui.init({
			swipeBack:true //启用右滑关闭功能
		});
		mui.plusReady(function() {  
			plus.oauth.getServices(function(services){
				auths = services;
			}, function(e) {
				alert("获取登录服务列表失败：" + e.message + " - " + e.code);
			});
		})
		/*document.getElementById('qq').addEventListener('tap',function() {
			console.log("QQ");
			tyindex=1;
			authLogin('qq');
		})*/
		document.getElementById('weixin').addEventListener('tap',function() {
			console.log("微信");
			tyindex=2;
			authLogin('weixin');
		})
		/*document.getElementById('sinaweibo').addEventListener('tap',function() {
			console.log("微博");
			tyindex=3;
			authLogin('sinaweibo');
		})*/
		// 登录操作
		function authLogin(type) {
			var s;
			for (var i = 0; i < auths.length; i++){
				if (auths[i].id == type){
					s = auths[i];
					break;
				}
			}
			if(!s.authResult) {
				s.login(function(e) {
					mui.toast("登录认证成功！");
					authUserInfo(type);
				}, function(e) {
					mui.toast("登录认证失败！");
				});
			} else {
				mui.toast("已经登录认证！");
			}
		}
		//注销
		function authLogout() {
			for (var i in auths) {
				var s = auths[i];
				if (s.authResult) {
					s.logout(function(e) {
						console.log("注销登录认证成功！");
					}, function(e) {
						console.log("注销登录认证失败！");
					});
				}
			}
		}
		// 微信登录认证信息
		function authUserInfo(type) {
			var s;
			for (var i = 0; i < auths.length; i++){
				if (auths[i].id == type) {
					s=auths[i];
					break;
				}
			}
			if (!s.authResult) {
				mui.toast("未授权登录！");
			} else {
//		昵称/头像/性别/openid
				s.getUserInfo(function(e) {
					console.log(JSON.stringify(s));
					var kks=JSON.parse(JSON.stringify(s));
					//获取opendid
					var opendids=kks.authResult.openid;
					var datask={
						openID:opendids,
						type:tyindex
					}
					console.log(JSON.stringify(datask));
					ajaxsd("third/login",'post',datask,function(data){
//						8：账号未绑定	9：绑定过，但是失效了	0：登陆成功
						console.log(JSON.stringify(data));
						if(data.code==0){//登录成功,跳转首页
							window.location.href="../home/home.html";
						}else if(data.code==8){//跳转绑定页面
							console.log("去绑定");
							if(tyindex==2){//微信
								var information={
									nickname:kks.userInfo.nickname,//昵称
									gender:kks.userInfo.sex,//性别
									openid:opendids,//opendid
									portrait:kks.userInfo.headimgurl,//头像
									type:tyindex
								}
								console.log(kks.userInfo.nickname);//昵称
								console.log(kks.userInfo.sex);//性别
								console.log(opendids);//opendid
								console.log(kks.userInfo.headimgurl);//头像
								localStorage.setItem('grxs', JSON.stringify(information));
								window.location.href="binding.html";
							}
						}else if(data.code==9){
							alert(data.message);
						}else{
							console.log("错误");
						}
					},function(err){
						console.log(err);
						console.log(JSON.stringify(err));
					})
					authLogout();
				}, function(e){
					alert("获取用户信息失败：" + e.message + " - " + e.code);
				});
			}
		}
	})
</script>
	</body>
</html>
	
<!--测试通过-->
<!--keytool -genkey -alias android.keystore -keyalg RSA -validity 20000 -keystore D:/android.keystore-->
<!--不能再C盘读写，放在其他盘，待测试-->
<!--keytool -importkeystore -srckeystore D:/android.keystore -destkeystore D:/android.keystore -deststoretype pkcs12-->


<!--微信AppSecret：7a94a0c17bdba9acff884602fdedafe3-->
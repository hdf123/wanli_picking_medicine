<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>购物车</title>
		<link rel="stylesheet" href="../../css/base.css" />
		<link rel="stylesheet" href="../../css/iconfont.css" />
		<link rel="stylesheet" href="../../css/layout.css" />
		<link rel="stylesheet" href="css/shopping_cart.css" />
		<script src="../../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/ajaxs.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/children.js" type="text/javascript" charset="utf-8"></script>
	</head>
	<body>
		<header class="headersd">
			<div class="iconfont icon-houtui" onclick="javascript:history.back(-1);"></div>
			<div>购物车</div>
			<div>管理</div>
		</header>
		<section class="sets">
			<div></div>
		</section>
		<footer class="totals">
			<div class="jiesuan">
				<div>
					<div>合计：</div>
					<div class="zjs iconfont icon-jinqian">0</div>
				</div>
				<div>结算(<span>0</span>)</div>
			</div>
			<div class="scs">
				<div class="qks">
					<div>清空购物车</div>
				</div>
				<div class="shan">删除</div>
			</div>
			
		</footer>
<script type="text/javascript">
	$(function(){
		$(".scs").hide();
		$(".jiesuan").show();
		ajaxsd("cart/myShoppingCart",'post',{},function(data){
			console.log(data);
			console.log(data[0].msg);
			if(data[0].msg=="购物车空空的"){
				
			}else{
				var ks="";
				for(i in data){
					for(j in data[i].msg){
						var sd=data[i].msg[j].equipmentGoods.picture.split(",");
						var nums=data[i].msg[j].equipmentGoods.presentPrice*data[i].msg[j].num
						ks+=`<div class="shopa" data-sta=${data[i].msg[j].shoppingCartId} data-family=${data[i].msg[j].equipmentName}>
								<div>
									<div class="iconfont icon-danxuankuang xuanz"></div>
									<div>
										<img src=${sd[0]} alt="" />
									</div>
									<div>
										<div>${data[i].msg[j].equipmentGoods.name}</div>
										<div>
											<div class="rpk iconfont icon-jinqian" data-jiag=${data[i].msg[j].equipmentGoods.presentPrice}>${nums}</div>
											<div class="nums">
												<div class="iconfont icon-jian"></div>
												<input type="text" placeholder="1" class="monsy" data-num=${data[i].msg[j].num} value=${data[i].msg[j].num} />
												<div class="iconfont icon-jia"></div>
											</div>
										</div>
									</div>
								</div>
								<div>${data[i].msg[j].equipmentName}</div>
							</div>`;
					}
				}
				$(".sets>div").html(ks);
				//增加商品
				$(".sets").on("click",".icon-jia",function(){
					var ints=$(this);
					var a1="cart/plusCartNum";
					var a2="+"
					funh(ints,a1,a2);
				})
				//减少商品
				$(".sets").on("click",".icon-jian",function(){
					var ints=$(this);
					var a1="cart/reduceCartNum";
					var a2="-"
					if($(this).siblings(".monsy").val()<=1){
						alert("至少选择一件商品");
					}else{
						funh(ints,a1,a2);
					}
				})
				$(".monsy").blur(function(){
					var ff=$(this);
					var num=$(this).val();
					if($(this).val()==""||$(this).val()==0){
						alert("至少要选择一件商品");
						$(this).val($(this).data("num"));
					}else{
						var sta=$(this).closest(".shopa").data("sta");
						ajaxsd("cart/customCartNum",'post',{shoppingCartId:sta,num:num},function(data){
							console.log(data);
						},function(err){
							console.log(err);
						})	
					}
				})
				function funh(ints,a1,a2){
					var sta=ints.closest(".shopa").data("sta");
					ajaxsd(a1,'post',{shoppingCartId:sta},function(data){
						console.log(data);
						var ak=parseInt(ints.siblings(".monsy").val());
						if(a2=="+"){
							ints.siblings(".monsy").val(ak+1);
						}else{
							ints.siblings(".monsy").val(ak-1);
						}
						var aas=ints.parent().siblings(".rpk").data("jiag")
						var aak=ints.siblings(".monsy").val();
						ints.parent().siblings(".rpk").html(aas*aak);
					},function(err){
						console.log(err);
					})	
				}
				//选择
				var arr=[],arr1=[],arr2=[],numa="";
				$(".sets").on("click",".xuanz",function(){
					var aa=$(this);
					var xuanz=aa.closest(".shopa").data("family");
					var arrid=aa.closest(".shopa").data("sta");
					if(arr.length==0){
						arr.push(xuanz);
						arr1.push(xuanz);
						funk(aa,arrid);
					}else{
						if(xuanz!=arr[0]){
							alert("同时只能结算单家商品!");
						}else{
							funk(aa,arrid);
						}
					}
					function funk(aa,arrid){
						if(aa.is(".icon-danxuankuang")){
							aa.removeClass("icon-danxuankuang");
							aa.addClass("icon-xuanze");
							aa.addClass("sha");
							arr2.push(arrid);
							var zjs=parseInt($(".zjs").html());
							var kss=parseInt(aa.closest(".shopa").find(".rpk").html());
							$(".zjs").html(zjs+kss);
							var aaa=$(".sets .icon-xuanze").length;
							$(".jiesuan>div:eq(1)>span").html(aaa);
						}else{
							aa.addClass("icon-danxuankuang");
							aa.removeClass("icon-xuanze");
							aa.removeClass("sha");
							removeWithoutCopy(arr2,arrid);
							function removeWithoutCopy(arr2, arrid){
							     for(var i = 0; i < arr2.length; i++){
							         if(arr2[i] == arrid){
							             //splice方法会改变数组长度，当减掉一个元素后，后面的元素都会前移，因此需要相应减少i的值
							             arr2.splice(i,1);
							             i--;
							         }
							     }
							     return arr2;
							}
							var zjs=parseInt($(".zjs").html());
							var kss=parseInt(aa.closest(".shopa").find(".rpk").html());
							$(".zjs").html(zjs-kss);
							var aaa=$(".sets .icon-xuanze").length;
							$(".jiesuan>div:eq(1)>span").html(aaa);
						}
					}
				})
			//管理
				var fals=true,fala=true;
				$(".headersd>div:eq(2)").click(function(){
					if(fala){
						fala=false;
						$(this).html("完成");
						$(".scs").show();
						$(".jiesuan").hide();
					}else{
						fala=true;
						$(".headersd>div:eq(2)").html("管理");
						$(".scs").hide();
						$(".jiesuan").show();
					}
				})
			//删除
				$(".totals").on("click",".shan",function(){
					var ark=arr2.join(",");
					ajaxsd("cart/deleCart",'post',{shoppingCartId:ark},function(data){
						console.log(data);
						if($(".xuanz").is(".icon-xuanze")){
							$(".icon-xuanze").closest(".shopa").remove();
							$(".zjs").html(0);
							$(".jiesuan>div:eq(1)>span").html(0);
						}
					},function(err){
						console.log(err);
					})
				})
			//清空购物车
				$(".totals").on("click",".qks",function(){
					ajaxsd("cart/emptyCart",'post',{},function(data){
						console.log(data);
					},function(err){
						console.log(err);
					})
				})
			//结算
				$(".jiesuan>div:eq(1)").click(function(){
					var aa=$(".jiesuan>div:eq(1)>span").html();
					if(aa>0){
						console.log(arr2);
						var joins=arr2.join(",");
						var kk={
							aa:joins,
							bb:1
						}
						localStorage.setItem('kiss', JSON.stringify(kk));
						window.location.href="sure_order.html";
					}else{
						alert("请选择您要结算的商品");
					}
				})
			}
		},function(err){
			console.log(err);
		})
	})
</script>
	</body>
</html>
